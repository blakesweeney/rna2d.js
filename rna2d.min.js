(function(){var a=window.Rna2D||function(b){var c=function(){c.nucleotides.computeOrder();c.view.setup();d3.select(c.selection()).call(function(e){var d=c.margin();c.width(c.width()-d.left-d.right);c.height(c.height()-d.above-d.below);e.select("svg").remove();var f=e.append("svg").attr("width",c.width()+d.left+d.right).attr("height",c.height()+d.above+d.below);c.vis=f.append("g").attr("transform","translate("+d.left+","+d.above+")");c.coordinates(function(h){var g=c.views[c.view()].xCoord(),i=c.views[c.view()].yCoord();h.attr("id",c.nucleotides.getID()).attr("class",function(k,j){return c.nucleotides["class"]()+" "+c.nucleotides.classOf()(k,j)}).datum(function(k,j){k.__x=g(k,j);k.__y=i(k,j);return k}).attr("data-sequence",c.nucleotides.getSequence());a.utils.attachHandlers(h,c.nucleotides);return h});c.connections(function(g){var h=c.interactions.getNTs(),i=c.interactions.visible();g.attr("id",c.interactions.getID()).attr("class",function(k,j){return c.interactions["class"]()+" "+c.interactions.classOf()(k,j)}).attr("visibility",function(j){j.__visibility=i(j);return(i(j)?"visible":"hidden")}).attr("data-nts",function(k,j){return h(k).join(",")}).attr("nt1",function(k,j){return h(k)[0]}).attr("nt2",function(k,j){return h(k)[1]});a.utils.attachHandlers(g,c.interactions);return g});c.groups(function(g){var h=c.motifs.getNTs();g.attr("id",c.motifs.getID()).attr("class",function(k,j){return c.motifs["class"]()+" "+c.motifs.classOf()(k,j)}).attr("data-nts",function(i){return c.motifs.getNTs()(i).join(",")}).datum(function(k,j){k.__visible=c.motifs.visible()(k,j);return k}).attr("visibility",function(i){return(i.__visible?"visible":"hidden")});a.utils.attachHandlers(g,c.motifs);return g});c.components();return c})};a.config(c,b);a.components(c);a.views(c);return c};window.Rna2D=a;a.components=function(b){b.components=function(){$.each(a.components,function(c,e){if(e.hasOwnProperty("actions")){e.actions(b)}if(e.hasOwnProperty("generate")){try{e.generate(b)}catch(d){console.log("Error generating component "+c);console.log(d)}}})};$.each(a.components,function(c,d){(function(f){var e=null;b[f]=function(g){if(!arguments.length){return e}e=g;return b[f]}}(c));a.utils.generateAccessors(b[c],d.config(b));if(d.hasOwnProperty("sideffects")){d.sideffects(b)}b.components[c]=d});return a};a.config=function(c,d){var b={labels:[],margin:{left:10,right:10,above:10,below:10},view:"circular",width:500,height:1000,selection:null,xScale:null,yScale:null};a.utils.generateAccessors(c,$.extend(b,d));return c};a.utils=(function(){var b={};b.distance=function(d,c){return Math.sqrt(Math.pow(c.x-d.x,2)+Math.pow(c.y-d.y,2))};b.generateAccessors=function(d,c,e){$.each(c,function(f,g){d[f]=(function(){return function(h){if(!arguments.length){return c[f]}var i=c[f];c[f]=h;if(e&&e[f]){e[f](i,h)}return d}}())})};b.attachHandlers=function(d,e){var c=["click","mouseover","mouseout"];if(e.mouseover()==="highlight"){d.on(c.pop(),e.normalize()).on(c.pop(),e.highlight())}$.each(c,function(f,g){d.on(g,e[g]())});return d};b.element=function(c){return document.getElementById(c)};return b}());a.views=function(b){b.view.setup=function(){var c=a.views[b.view()];if(c===undefined){console.log("Unknown view "+b.view());return false}b.coordinates=c.coordinates;b.connections=c.connections;b.groups=c.groups;c.sideffects()};b.views={};$.each(a.views,function(e,c){c=c(b);var d=c.config;if(typeof(d)==="function"){d=d(b)}b.views[e]={};a.utils.generateAccessors(b.views[e],d);a.views[e]=c})};a.components.brush=(function(){var d,c,b;return{config:function(e){return{enabled:true,initial:[],"class":"brush",update:Object,clear:Object}},actions:function(e){e.brush.select=function(f){d();e.brush().extent(f);c();e.vis.select("."+e.brush["class"]()).call(e.brush());b();return e.brush};e.brush.enable=function(){e.vis.append("g").classed(e.brush["class"](),true).call(e.brush());e.brush.enabled(true);return e.brush};e.brush.disable=function(){e.vis.selectAll("."+e.brush["class"]()).remove();e.brush.enabled(false);return e.brush};e.brush.toggle=function(){if(e.brush.enabled()){return e.brush.disable()}return e.brush.enable()}},generate:function(e){d=function(){return"bobo"};c=function(f){};b=function(){var f=[];if(e.brush().empty()){e.brush.clear()}else{var g=e.brush().extent();e.vis.selectAll("."+e.nucleotides["class"]()).attr("checked",function(h){if(g[0][0]<=h.__x&&h.__x<=g[1][0]&&g[0][1]<=h.__y&&h.__y<=g[1][1]){f.push(h)}});e.brush.update()(f)}};e.brush(d3.svg.brush().on("brushstart",d).on("brush",c).on("brushend",b).x(e.xScale()).y(e.yScale()));if(e.brush.initial().length){e.brush.select(e.brush.initial())}if(e.brush.enabled()){e.brush.enable()}return e.brush}}}());a.components.frame={config:function(b){return{add:true,"class":"frame"}},generate:function(b){if(!b.frame.add()){return b.vis}return b.vis.append("svg:rect").classed(b.frame["class"](),true).attr("x",0).attr("y",0).attr("width",b.width()+b.margin().left+b.margin().right).attr("height",b.height()+b.margin().below+b.margin().above).style("pointer-events","none")}};a.components.interactions=(function(){return{config:function(b){return{getFamily:function(c){return c.family},getNTs:function(c){return[c.nt1,c.nt2]},visible:function(e){var c=b.interactions.getFamily()(e);return c==="cWW"||c==="ncWW"},mouseover:null,mouseout:null,click:function(e){var c=b.interactions.nucleotides(this);b.jmol.showSelection(c.data())},"class":"interaction",classOf:function(c){return c.family},highlightColor:function(){return"red"},highlight:Object,normalize:Object,isForward:function(f){var c=b.interactions.getFamily(),e=c(f);if(e.length===3){e=e.slice(1,3).toUpperCase()}else{e=e.slice(2,4).toUpperCase()}return e==="WW"||e==="WH"||e==="WS"||e==="HH"||e==="SH"||e==="SS"},isSymmetric:function(g,e){var c=b.interactions.getFamily(),f=c(g);return f[1]===f[2]},getID:function(f){var c=b.interactions.getFamily()(f),e=b.interactions.getNTs()(f);if(b.interactions.isSymmetric()(f)){e.sort()}e.push(c);return e.join("-")},color:"black"}},sideffects:function(b){b.interactions.valid=function(){var i=b.interactions(),f=b.interactions.getID(),e=b.interactions.getNTs(),h=b.interactions.isForward(),g=[],c={},d=b.nucleotides.indexOf;$.each(i,function(j,l){var m=f(l),k=e(l);if(h(l)&&!c[m]&&k.length&&d(k[0])!==null&&d(k[1])!==null){c[m]=true;g.push(l)}});return g}},actions:function(b){b.interactions.all=function(c){c=c||b.interactions["class"]();return b.vis.selectAll("."+c)};b.interactions.nucleotides=function(f){f=f||this;var e=d3.select(f).datum(),d=b.interactions.getNTs()(e),c="#"+d.join(", #");return b.vis.selectAll(c)};b.interactions.show=function(c){return b.interactions.all(c).attr("visibility",function(d){d.__visibility=true;return"visible"})};b.interactions.hide=function(c){return b.interactions.all(c).attr("visibility",function(d){d.__visibility=false;return"hidden"})};b.interactions.toggle=function(c){return b.interactions.all(c).attr("visibility",function(d){if(d.__visibility){d.__visibility=false;return"hidden"}d.__visibility=true;return"visible"})}}}}());a.components.jmol={config:function(b){return{divID:"jmol",appID:"jmolApplet0",tmpID:"tempJmolToolsObj",neighborhoodID:"neighborhood",numbersID:"showNtNums",stereoID:"stero",maxSize:200,overflow:Object,windowSize:400,windowBuild:function(c){c.append('<label><input type="checkbox" id="showNtNums">Numbers</label>').append('<input type="button" id="neighborhood" value="Show neighborhood">').append('<input type="button" id="stereo" value="Stereo">')}}},sideffects:function(b){b.jmol.setup=function(){var c=$("#"+b.jmol.appID()),d=$("#"+b.jmol.divID());if(c.length===0){d.html(jmolApplet(b.jmol.windowSize(),"",0));b.jmol.windowBuild()(d);d.show()}jmolScript("zap;");$.jmolTools.numModels=0;$.jmolTools.stereo=false;$.jmolTools.neighborhood=false;$("#"+b.jmol.neighborhoodID()).val("Show neighborhood");$.jmolTools.models={};$("#"+b.jmol.stereoID()).unbind();$("#"+b.jmol.neighborhoodID()).unbind();$("#"+b.jmol.numbersID()).unbind();return b.jmol};b.jmol.showSelection=function(c){b.jmol.setup();if(c.length>b.jmol.maxSize()){return b.jmol.overflow()}var d=$.map(c,b.nucleotides.getID());d=d.join(",");$("#"+b.jmol.tmpID()).remove();$("body").append("<input type='radio' id='"+b.jmol.tmpID()+"' data-coord='"+d+"'>");$("#"+b.jmol.tmpID()).hide();$("#"+b.jmol.tmpID()).jmolTools({showNeighborhoodId:b.jmol.neighborhoodID(),showNumbersId:b.jmol.numbersID(),showStereoId:b.jmol.stereoID()}).jmolToggle();return b.jmol}}};a.components.labels={config:function(b){return{majorTickClass:"major-tick",minorTickClass:"minor-tick",labelClass:"label",width:5,fontSize:12,majorTickCount:30,minorTickCount:150,}}};a.components.motifs=(function(){return{config:function(b){return{classOf:function(c){return c.id.split("_")[0]},"class":"motif",highlightColor:function(){return"red"},visible:function(c){return true},click:function(e){var c=b.motifs.nucleotides(this).data();return b.jmol.showSelection(c)},mouseover:null,mouseout:null,getID:function(c){return c.id},getNTs:function(c){return c.nts},highlight:Object,normalize:Object}},actions:function(b){b.motifs.all=function(){return b.vis.selectAll("."+b.motifs["class"]())};b.motifs.nucleotides=function(e){var f=d3.select(e).datum(),d=b.motifs.getNTs()(f),c="#"+d.join(", #");return b.vis.selectAll(c)};b.motifs.show=function(){var c=b.motifs.visible();return b.motifs.all().datum(function(f,e){f.__visible=c(f,e);return f}).attr("visibility",function(f,e){return(f.__visible?"visible":"hidden")})};b.motifs.hide=function(){var c=b.motifs.visible();return b.motifs.all().datum(function(f,e){f.__visible=c(f,e);return f}).attr("visibility",function(f,e){return(f.__visible?"hidden":"visible")})};b.motifs.toggle=function(){var c=b.motifs.visible();b.motifs.all().datum(function(f,e){f.__visible=!f.__visible;return f}).attr("visibility",function(f,e){return(f.__visible?"visible":"hidden")})}}}}());a.components.nucleotides=(function(){var b={};return{config:function(c){return{highlightColor:function(){return"red"},"class":"nucleotide",classOf:function(f,e){return""},color:"black",click:function(f,e){return c.jmol.showSelection([f])},mouseover:null,mouseout:null,getID:function(e){return e.id},getX:function(e){return e.x},getY:function(e){return e.y},getSequence:function(e){return e.sequence},highlight:Object,normalize:Object,toggleLetters:Object}},sideffects:function(c){c.nucleotides.computeOrder=function(){var e=c.nucleotides(),d=c.nucleotides.getID();$.each(e,function(g,f){b[d(f)]=g});return c.nucleotides};c.nucleotides.indexOf=function(d){if(!b.hasOwnProperty(d)){return null}return b[d]};c.nucleotides.ordered=function(d){if(!arguments.length){return b}b=d;return c.nucleotides}},actions:function(c){c.nucleotides.selector=function(){return"."+c.nucleotides["class"]()};c.nucleotides.all=function(){return c.vis.selectAll(c.nucleotides.selector())};c.nucleotides.interactions=function(f){var e=f||this;var d="[nt1="+e.getAttribute("id")+"], [nt2="+e.getAttribute("id")+"]";return c.vis.selectAll(d)};c.nucleotides.doColor=function(){return c.nucleotides.all().attr("fill",c.nucleotides.color())}}}}());a.views.airport=function(g){var f,d;var c=function(u,t,q){var l=u.getBBox(),k=t.getBBox(),w=l.x,j=l.y,v=k.x,i=k.y,p=v-w,o=i-j,m=0.004;var B=function(r){return(r<0?-1:1)},n=function(r){return{x:r.x+r.width/2,y:r.y+r.height/2}},s=function(r,C){return Math.sqrt(Math.pow(r,2)+Math.pow(C,2))};if(Math.abs(o)<m){j=j+l.height/2;if(w<v){return{x:w+l.width+q,y:j}}return{x:w-q,y:j}}if(Math.abs(p)<m){w=w+l.width/2;if(j>i){return{x:w,y:j}}return{x:w,y:j+l.height}}q=1;var y=n(l),x=s(p,o),A=B(p)*Math.abs(p*q/x),z=B(o)*s(q,A);return{x:y.x+A,y:y.y+z}};var h=function(j){var n=g.nucleotides(),k=g.width(),i=g.height();f=d3.max(n,function(o){return o.x});d=d3.max(n,function(o){return o.y});var m=d3.scale.linear().domain([0,f]).range([0,k]),l=d3.scale.linear().domain([0,d]).range([0,i]);g.xScale(m);g.yScale(l);g.vis.selectAll(g.nucleotides["class"]()).data(n).enter().append("svg:text").call(j).attr("x",function(p,o){return m(g.nucleotides.getX()(p,o))}).attr("y",function(p,o){return l(g.nucleotides.getY()(p,o))}).attr("font-size",g.views.airport.fontSize()).text(g.nucleotides.getSequence()).attr("fill",g.nucleotides.color());return g};var e=function(i){var k=g.interactions.valid(),j=g.interactions.getNTs();k=$.map(k,function(r,l){try{var p=j(r),o=a.utils.element(p[0]),m=a.utils.element(p[1]),s=c(o,m,g.views.airport.gap()),q=c(m,o,g.views.airport.gap());r.line={x1:s.x,y1:s.y,x2:q.x,y2:q.y}}catch(n){console.log("Could not compute interaction line for",r);return null}return r});g.vis.selectAll(g.interactions["class"]()).data(k).enter().append("svg:line").call(i).attr("stroke",g.interactions.color()).attr("x1",function(l){return l.line.x1}).attr("y1",function(l){return l.line.y1}).attr("x2",function(l){return l.line.x2}).attr("y2",function(l){return l.line.y2});return g};var b=function(l){var k=g.motifs(),o=0,n=0;if(!k||!k.length){return g}$.each(k,function(q,u){var t=0,p=f,s=d,j=0,v=g.motifs.visible();u.visible=v(u);u.missing=[];var r=g.motifs.getNTs()(u);$.each(r,function(i,y){var w=a.utils.element(y);if(w===null){console.log("Missing nt "+y+" in motif: ",u);u.missing.push(y)}else{var x=w.getBBox();if(x.x<p){p=x.x}if(x.x+x.width>t){t=x.x+x.width}if(x.y+x.height>j){j=x.y+x.height}if(x.y<s){s=x.y}}});if(j===0||t===0||p===f||s===d){console.log("Unlikely bounding box found for "+u.id);u.bounding=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}]}else{u.bounding=[{x:t,y:s},{x:t,y:j},{x:p,y:j},{x:p,y:s}]}});var m=d3.svg.line().x(function(i){return i.x}).y(function(i){return i.y});g.vis.selectAll(g.motifs["class"]()).data(g.motifs()).enter().append("svg:path").call(l).attr("missing-nts",function(i){return i.missing.join(" ")}).attr("d",function(i){return m(i.bounding)+"Z"});return g};return{config:{fontSize:11,gap:1,xCoord:function(k,j){return g.xScale()(g.nucleotides.getX()(k,j))},yCoord:function(k,j){return g.yScale()(g.nucleotides.getY()(k,j))}},connections:e,coordinates:h,groups:b,sideffects:function(){g.interactions.highlight(function(){var i=this,j=g.interactions.highlightColor();d3.select(i).style("stroke",j(i));return g.interactions.nucleotides(i).style("stroke",j(i))});g.interactions.normalize(function(){var i=this;d3.select(i).style("stroke",null);return g.interactions.nucleotides(i).style("stroke",null)});g.nucleotides.highlight(function(){var i=this,j=g.nucleotides.highlightColor();d3.select(i).style("stroke",j());return g.nucleotides.interactions(i).style("stroke",j())});g.nucleotides.normalize(function(){var i=this;d3.select(i).style("stroke",null);return g.nucleotides.interactions(i).style("stroke",null)});g.motifs.highlight(function(){var i=this,j=g.motifs.highlightColor();return g.motifs.nucleotides(i).style("stroke",j(i))});g.motifs.normalize(function(){var i=this;return g.motifs.nucleotides(i).style("stroke",null)})}}};a.views.circular=function(j){var g=j.interactions.getNTs();var n,p,c,l,b,k,e;var h;var f;var i=function(s){var q=f.centroid(null,j.nucleotides.indexOf(s)),r=j.views.circular.center()();return{x:r.x+q[0],y:r.y+q[1]}};var d=function(v,r){var q=j.nucleotides().length,w=j.nucleotides.indexOf,t=g(v).sort(function(C,A){var B=w(C),z=w(A);if(Math.abs(B-z)>q/2){return z-B}return B-z});var x=i(t[0]),y=i(t[1]),u=k(null,w(t[0]))-k(null,w(t[1])),s=Math.abs(f.innerRadius()()*Math.tan(u/2));return"M "+x.x+" "+x.y+" A "+s+","+s+" 0 0,0 "+y.x+","+y.y};var m=function(q){n=j.views.circular.radius()();p=n-j.views.circular.width();c=j.views.circular.center()();l=(2*Math.PI-j.views.circular.arcGap())/j.nucleotides().length;b=j.views.circular.arcGap()/2;k=function(s,r){return r*l+b};e=function(s,r){return(r+1)*l+b};h=d3.svg.arc().outerRadius(n).innerRadius(p).startAngle(k).endAngle(e);j.xScale(d3.scale.identity().domain([0,j.width()])).yScale(d3.scale.identity().domain([0,j.height()]));j.vis.selectAll(j.nucleotides["class"]()).append("g").data(j.nucleotides()).enter().append("svg:path").call(q).attr("d",h).attr("transform","translate("+c.x+","+c.y+")").attr("fill",j.nucleotides.color());return j};var o=function(q){f=d3.svg.arc().outerRadius(p).innerRadius(p-j.views.circular.interactionGap()).startAngle(k).endAngle(e);return j.vis.selectAll(j.interactions["class"]()).data(j.interactions.valid()).enter().append("path").call(q).attr("d",d).attr("fill","none").attr("stroke",j.interactions.color())};return{coordinates:m,connections:o,groups:function(q){return j},config:{radius:function(){return j.width()/4},width:4,arcGap:0.2,interactionGap:3,letterClass:"nucleotide-letter",xCoord:function(r,q){return h.centroid(null,q).x},yCoord:function(r,q){return h.centroid(null,q).y},center:function(){return{x:j.width()/2,y:j.height()/2}},letterID:function(q){return q.getAttribute("id")+"-letter"},letterSize:20,letterPosition:function(t){var s=j.nucleotides.indexOf(t.getAttribute("id")),r=h.centroid(null,s),q=j.views.circular.center()();return{x:q.x+r[0],y:q.y+r[1]}},addLetters:function(r){var q=j.views.circular.letterPosition(),s=j.nucleotides.highlightColor();j.vis.selectAll(j.views.circular.letterClass()).data(r).enter().append("svg:text").attr("id",j.views.circular.letterID()).attr("class",j.views.circular.letterClass()).attr("x",function(t){return q(t).x}).attr("y",function(t){return q(t).y}).attr("font-size",j.views.circular.letterSize()).attr("pointer-events","none").text(function(t){return t.getAttribute("data-sequence")}).attr("fill",function(t){return s(t)});return j},clearLetters:function(){return j.vis.selectAll("."+j.views.circular.letterClass()).remove()}},sideffects:function(){j.nucleotides.highlight(function(){var q=this,r=j.nucleotides.highlightColor();d3.select(q).style("stroke",r(q));j.views.circular.addLetters()([q]);return j.nucleotides.interactions(q).style("stroke",r(q))});j.nucleotides.normalize(function(){var q=this;d3.select(q).style("stroke",null);j.views.circular.clearLetters()();return j.nucleotides.interactions(q).style("stroke",null)});j.interactions.highlight(function(){var r=this,s=j.interactions.highlightColor(),q=j.interactions.nucleotides(r);d3.select(r).style("stroke",s(r));j.views.circular.addLetters()(q[0]);return q.style("stroke",s(r))});j.interactions.normalize(function(){var q=this;d3.select(q).style("stroke",null);j.views.circular.clearLetters()();j.interactions.nucleotides(q).style("stroke",null);return j.interactions})}}}}());